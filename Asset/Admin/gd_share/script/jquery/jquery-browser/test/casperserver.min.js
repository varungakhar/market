var fs=require("fs");var webserver=require("webserver");exports.create=function create(c,a){var b=new Server(c,a);c.server=b;return b};var Server=function Server(b,a){this.casper=b;a=a||{};this.options={};this.options.port=a.port||8008;this.options.defaultStatusCode=a.defaultStatusCode||200;this.options.responsesDir=a.responsesDir||"./";this.watchedPaths={"^/(\\?.*)?$":{filePath:"test/index.html",permanent:true},"/src/jquery.browser.js":{filePath:"test/src/jquery.browser.js",permanent:true},"/src/jquery-1.10.2.min.js":{filePath:"test/src/jquery-1.10.2.min.js",permanent:true}};this.watchedRequests={}};exports.Server=Server;Server.prototype.start=function start(){this.webserver=webserver.create();var a=this;this.service=this.webserver.listen(this.options.port,function(c,b){a._serve(c,b)});this.log("server started")};Server.prototype.end=function start(){this.webserver.close();this.log("server closed")};Server.prototype._serve=function serve(c,a){a.statusCode=this.options.defaultStatusCode;this.log("handling "+c.method+" on "+c.url,"debug");if(typeof this.watchedRequests[c.url]!=="undefined"){if(c.headers["Content-Type"]!="application/x-www-form-urlencoded"){this._splitFormData(c)}this.watchedRequests[c.url]=c}var b={};for(var d in this.watchedPaths){if(c.url.search(d)!==-1){b=this.watchedPaths[d];this.log("Build response from watched path "+c.url);if(!b.permanent){this.unwatchPath(d)}break}}b._request=c;this._buildResponse(a,b)};Server.prototype._buildResponse=function _buildResponse(a,b){var e,d,c,b=b||{};if(b.content){if(typeof b.content==="function"){e=b.content(b._request)}else{e=b.content}}else{if(b.filePath){if(typeof b.filePath==="function"){c=b.filePath(b._request)}else{c=b.filePath}}else{c=b._request.url}if(!/^(\.|\/)/.test(c)){c=this.options.responsesDir+c}if(fs.exists(c)){this.log("Getting content from "+c);e=fs.read(c)}else{this.log("File not found: "+c,"error")}}if(b.statusCode){a.statusCode=b.statusCode}if(!e){a.statusCode=404;e="No handler for the url "+b._request.url}a.write(e);a.close()};Server.prototype.log=function log(a,b){if(typeof b=="undefined"){b="debug"}this.casper.log("[casperserver] "+a,b)};Server.prototype._splitFormData=function _splitFormData(e){var i={},g=e.post.trim(),b="--"+e.headers["Content-Type"].split("boundary=")[1],f=g.split(b),l,a,h;for(var d=1,c=f.length;d<c;d++){if(!f[d]||f[d]=="--"){continue}l=f[d].split("\r\n");h=l[3];a=l[1].match(/name="(\S+)"/i)[1];i[a]=h}e.post=i;return e};Server.prototype.watchPath=function(b,a){this.watchedPaths[b]=a};Server.prototype.unwatchPath=function(a){delete this.watchedPaths[a]};Server.prototype.watchRequest=function(a){this.watchedRequests[a]=null};Server.prototype.unwatchRequest=function(a){delete this.watchedRequests[a]};Server.prototype.getWatchedRequest=function(b){if(!b){this.log("Can't retrieve watchedRequest for null path");return}var a=this.watchedRequests[b];delete this.watchedRequests[b];return a};